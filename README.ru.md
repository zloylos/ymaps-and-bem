# API Яндекс.Карт и БЭМ

Один из самых частых кейсов использования API Яндекс.Карт — создание меню для показа на карте организаций различных типов (коллекций геообъектов). С помощью такого меню пользователь сайта может отобразить на карте только те объекты, которые его интересуют. Например, [вот так](https://dimik.github.com/ymaps/examples/group-menu/menu03.html). Давайте реализуем этот пример на основе [БЭМ-методологии](https://ru.bem.info/method/)!

## Первые шаги

Создатели БЭМ позаботились о разработчиках и написали [проект-скелет](https://ru.bem.info/tutorials/project-stub/), который поможет начать разработку «с низкого старта». Им мы и воспользуемся.

Клонируем проект и устанавливаем все необходимые зависимости:

````bash
git clone https://github.com/bem/project-stub.git shopsList
cd shopsList
npm install
````

Теперь проект у нас на компьютере. Давайте протестируем, все ли работает. Для этого нужно в папке проекта запустить `enb server` и открыть в браузере страницу: [localhost:8080/desktop.bundles/index/index.html](http://localhost:8080/desktop.bundles/index/index.html).


Перед глазами должно появиться следующее:

![Скомпилированная страница BEM project stub](https://img-fotki.yandex.ru/get/6808/246231603.0/0_14ad3a_514cc2ef_orig)

Готово, можно переходить к следующему этапу.

## Общее видение проекта

Нам нужно создать несколько блоков:

* блок `map`, в котором будет находиться карта;
* блок `sidebar` (правая колонка), в котором будет находиться блок `menu`;
* блок `menu`, реализующий список организаций по категориям.

Использование БЭМ-методология подразумевает проектирование блоков таким образом, чтобы они не знали о существовании друг друга. Поэтому нам необходимо создать промежуточный блок, который будет принимать клики на меню и взаимодействовать с картой. Назовем его `i-geo-controller`.

Чтобы лучше понять, зачем нужен промежуточный блок, как он работает и что такое «миксы», рекомендуем посмотреть [рассказ Кира Белевича «Миксы во вселенной БЭМ»](https://events.yandex.ru/events/yasubbotnik/msk-sep-2012/talks/327/).

## Описание страницы – декларация BEMJSON

Здесь все просто. Мы продумали структуру страницы и ее основные блоки. Теперь осталось все это записать в JSON-подобном виде.

Структура страницы будет такой:

```
    page
    == container
    ==== map
    ==== sidebar
    ====== menu
    ======== items
```

![Структура страницы](https://img-fotki.yandex.ru/get/6822/246231603.0/0_14ad39_a3d53b98_orig)

В декларации BEMJSON запишем следующее:

```js
{
    block: 'page',
    content: [
        {
            block: 'container',
            content: [
                {
                    block: 'map'
                },
                {
                    block: 'sidebar',
                    content: [
                        {
                            block: 'menu',
                            content: [ /* menu items */ ]
                        }
                    ]
                }
            ]
        }
    ]
}
```

Не будем вдаваться в подробности, полный исходный код всегда можно посмотреть здесь: [desktop.bundles/index/index.bemjson.js](https://github.com/zloylos/ymaps-and-bem/blob/master/desktop.bundles/index/index.bemjson.js).

## Блок `map`

Начнем разработку с главного блока — карты. Прежде всего нужно подключить API с необходимыми опциями. Можно было бы создать отдельный блок `i-API`, но, удобнее реализовать все это в рамках одного блока, используя модификаторы. Для блока `map` мы создадим модификатор `api`, в котором для начала разместим значение `ymaps`. В примере мы будем использовать [динамический API](http://api.yandex.ru/maps/doc/jsapi/), но нужно помнить, что мы также можем использовать и [статический API](http://api.yandex.ru/maps/doc/staticapi/). Это можно реализовать в рамках модификаторов.

Для удобной работы с картой нам нужно продумать интерфейс добавления меток на карту без лишней «головной боли». Для этого сделаем обработку поля `geoObjects`, в котором будут храниться метки или коллекции.

Сделаем такой интерфейс:

* для метки

```js
{
    coords: [], // координаты метки
    properties: {}, // данные метки
    options: {}, // опции метки
}
```

* для коллекции

```js
{
    collection: true, // флаг, указывающий, что это коллекция / группа меток
    properties: {}, // свойства группы
    options: {}, // опции группы
    data: [], // массив меток
}
```

Это покрывает 90% всех кейсов.

## Блок `menu`

Нам нужно сделать двухуровневое меню. Создадим блок `menu`, который будет распознавать клики по группам и элементам. Соответственно, нам нужны следующие элементы:

* `item` — элемент меню;
* `content` — контейнер для элементов;
* `title` — заголовок группы.

Вкладывая один блок меню в другой, можно добиться необходимой иерархичности.

Например, простейшее меню, описанное в BEMJSON, будет выглядеть так:

```js
{
    block: 'menu',
    content: [
        {
            elem: 'title',
            content: 'menu title'
        },
        {
            elem: 'content',
            content: [
                {
                    elem: 'item',
                    content: 'menu-item-1'
                },
                {
                    elem: 'item',
                    content: 'menu-item-2'
                }
            ]
        }
    ]
}
```

## Блок `i-geo-controller`

Блок-контроллер подписывается на события блока `menu` — `menuItemClick` и `menuGroupClick` – и реагирует на них, совершая определенные действия на карте:

* при клике на метку перемещает ее в центр карты и открывает всплывающую подсказку;
* при клике на группу либо скрывает, либо показывает ее, если до этого она была скрыта.

Кроме того, чтобы правильно взаимодействовать с картой, блок-контроллер должен знать, готова ли карта к тому, чтобы объектами на ней можно было управлять. Для этого блок `map` у себя будет пробрасывать событие `map-inited`, а `i-geo-controller` слушать его и запоминать ссылку на экземпляр карты.

![Схема взаимодействия блоков](https://img-fotki.yandex.ru/get/5601/246231603.0/0_14ad36_42b4e730_orig)

## Заключение

Готовый пример можно посмотреть по ссылке: [http://zloylos.github.io/ymapsbem/](http://zloylos.github.io/ymapsbem/).

Использование БЭМ-методологии делает разработку нашего примера более громоздкой, чем без нее. Но в итоге мы получаем более структурированный и удобный для поддержки код, который просто масштабировать и развивать. Что без использования методологии вызвало бы значительные проблемы и чаще всего привело бы к полному переписыванию кода.

![Готовый пример](https://img-fotki.yandex.ru/get/6822/246231603.0/0_14ad35_1a7fe921_orig)

Спасибо [Саше Тармолову](https://twitter.com/tarmolov) за ценные советы и помощь.
